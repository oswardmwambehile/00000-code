{% extends "users/base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
{% include "users/sidebar.html" %}

<div class="main-panel">
  <div class="main-header">
    {% include "users/nav.html" %}
  </div>

  <div class="container">
    <div class="page-inner mt-4">

      <h3 class="mb-3">
        <i class="fas fa-clipboard-list text-primary me-2"></i>All Sales
      </h3>

      <!-- Filter by Created Date (optional) -->
      <form method="get" class="row g-3 mb-4 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Created Date</label>
          <input type="date" name="created_date" class="form-control" value="{{ created_date }}">
        </div>
        <div class="col-md-8 d-flex flex-wrap gap-2">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-filter me-1"></i> Filter
          </button>
          <a href="{% url 'sales_list' %}" class="btn btn-secondary">
            <i class="fas fa-undo me-1"></i> Reset
          </a>
          <a href="{% url 'new_sales' %}" class="btn btn-success">
            <i class="fas fa-plus me-1"></i> New Sale
          </a>
          <a href="{% url 'add_visit' %}" class="btn btn-dark">
            <i class="fas fa-home me-1"></i> Home
          </a>
        </div>
      </form>

      <!-- Sales Table -->
      {% if sales %}
      <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle w-100 custom-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Company Name</th>
              <th>Contact Person</th>
              <th>Status</th>
           
              <th>Created At</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for sale in sales %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ sale.company.company_name }}</td>
              <td>
                {% if sale.contact_person %}
                  {{ sale.contact_person.contact_name }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>
                <span class="badge 
                  {% if sale.status == 'Open' %}bg-info
                  {% elif sale.status == 'Won Paid' %}bg-success
                  {% elif sale.status == 'Lost' %}bg-danger
                  {% else %}bg-light text-dark{% endif %}">
                  {{ sale.status }}
                </span>
              </td>
             
              <td>{{ sale.created_at|date:"Y-m-d H:i" }}</td>
              <td class="text-nowrap">
  <!-- View Details -->
   <td>
  <a href="{% url 'sales_detail' sale.id %}" class="btn btn-sm btn-primary me-1 mb-1">
    <i class="fas fa-eye"></i> View Detail
  </a>

  
  <!-- Only show these buttons if not Won Paid or Lost -->
  {% if sale.status != "Won Paid" and sale.status != "Lost" %}
    <a href="{% url 'update_sale' sale.id %}" class="btn btn-sm btn-warning me-1 mb-1">
      <i class="fas fa-handshake"></i> Add Followup
    </a>

    <a href="{% url 'new_visit_for_sale' sale.id %}" class="btn btn-sm btn-dark mb-1">
      <i class="fas fa-paper-plane"></i> Submit Sales
    </a>
  {% endif %}

  
</td>


            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted">No sales found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          {% if sales.has_previous %}
            <li class="page-item"><a class="page-link" href="?page=1{% if created_date %}&created_date={{ created_date }}{% endif %}">« First</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ sales.previous_page_number }}{% if created_date %}&created_date={{ created_date }}{% endif %}">‹ Prev</a></li>
          {% endif %}

          <li class="page-item active">
            <span class="page-link">Page {{ sales.number }} of {{ sales.paginator.num_pages }}</span>
          </li>

          {% if sales.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ sales.next_page_number }}{% if created_date %}&created_date={{ created_date }}{% endif %}">Next ›</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ sales.paginator.num_pages }}{% if created_date %}&created_date={{ created_date }}{% endif %}">Last »</a></li>
          {% endif %}
        </ul>
      </nav>
      {% else %}
        <p class="text-muted">No sales found.</p>
      {% endif %}

    </div>
  </div>
</div>

<!-- Styling -->
<style>
  .custom-table td, .custom-table th { white-space: nowrap; vertical-align: middle; padding: 8px 12px; }
  .custom-table thead th { background: none !important; font-weight: 600; border-bottom: 2px solid #ccc; }
  .badge { font-size: 0.85rem; }
  @media (max-width: 768px){
    .table-responsive { overflow-x: auto; }
    .custom-table td, .custom-table th { font-size: 0.875rem; }
    .btn { flex: 1 1 auto; text-align: center; }
  }
</style>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

{% endblock %}
