{% extends "users/base.html" %}
{% load static %}

{% block content %}
{% include "users/sidebar.html" %}

<div class="main-panel">
  <div class="main-header">
    {% include "users/nav.html" %}
  </div>

  <div class="container">
    <div class="page-inner">
      <h3>Make Sales Order for {{ visit.company.company_name }}</h3>

      <form method="post" id="sales-form">
        {% csrf_token %}
        {{ formset.management_form }}

        <!-- Proposal Stage -->
        <div id="proposal-stage" {% if show_payment_followup_only %}style="display:none;"{% endif %}>
          <h5>Enter Product Prices</h5>
          <table class="table table-striped table-bordered">
            <thead class="thead-dark">
              <tr>
                <th>#</th>
                <th>Product</th>
                <th>Price (TZS)</th>
              </tr>
            </thead>
            <tbody>
              {% for form, product_interest in form_product_pairs %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ product_interest.product.name|default:"Unnamed Product" }}</td>
                <td>
                  {{ form.id }}
                  {{ form.price }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          <div class="form-check mb-3">
            <input type="checkbox" class="form-check-input" name="is_final_order" id="id_is_final_order"
              {% if sales.is_order_final %}checked{% endif %}>
            <label for="id_is_final_order" class="form-check-label">Mark as Final Order</label>
          </div>

          <p><strong>Total Amount:</strong> {{ total_amount|floatformat:2 }} TZS</p>
        </div>

        <!-- Closing Stage -->
        <div id="closing-stage" style="display: {% if show_closing %}block{% else %}none{% endif %}; margin-top:20px;">
          <h5>Closing Stage</h5>

          <div class="mb-3">
            <label>Contract Outcome</label>
            <select name="contract_outcome" id="contract_outcome" class="form-control">
              <option value="">Select</option>
              <option value="Won" {% if sales.contract_outcome == "Won" %}selected{% endif %}>Won</option>
              <option value="Lost" {% if sales.contract_outcome == "Lost" %}selected{% endif %}>Lost</option>
            </select>
          </div>

          <!-- Payment Collected -->
          <div class="mb-3" id="payment-collected-section"
               style="display: {% if sales.contract_outcome == 'Won' %}block{% else %}none{% endif %};">
            <label>Payment Collected</label>
            <select name="is_payment_collected" id="is_payment_collected" class="form-control">
              <option value="">Select</option>
              <option value="Yes-Full" {% if sales.is_payment_collected == "Yes-Full" %}selected{% endif %}>Yes-Full</option>
              <option value="Yes-Partial" {% if sales.is_payment_collected == "Yes-Partial" %}selected{% endif %}>Yes-Partial</option>
              <option value="No" {% if sales.is_payment_collected == "No" %}selected{% endif %}>No</option>
            </select>
          </div>

          <!-- Payment Follow-up -->
          <div id="payment-followup-section" style="display: {% if sales.is_payment_collected == 'Yes-Partial' %}block{% else %}none{% endif %}; margin-top:20px;">
            <h5>Payment Follow-up</h5>
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Price (TZS)</th>
                  <th>Total Paid (TZS)</th>
                  <th>Remaining (TZS)</th>
                  <th>New Collection (TZS)</th>
                </tr>
              </thead>
              <tbody>
                {% for obj in items_with_payment_info %}
                {% with item=obj.item %}
                <tr>
                  <td>{{ item.product.product.name|default:"Unnamed Product" }}</td>
                  <td>{{ item.price|floatformat:2 }}</td>
                  <td>{{ obj.total_paid|floatformat:2 }}</td>
                  <td>{{ obj.remaining|floatformat:2 }}</td>
                  <td>
                    <input type="number" step="0.01" name="collected_{{ item.id }}" class="form-control">
                  </td>
                </tr>
                {% endwith %}
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Reason for Lost -->
          <div class="mb-3" id="reason-lost-section"
               style="display: {% if sales.contract_outcome == 'Lost' %}block{% else %}none{% endif %};">
            <label>Reason for Lost</label>
            <textarea name="reason_lost" class="form-control" rows="3">{{ sales.reason_lost }}</textarea>
          </div>

          <p><strong>Total Amount:</strong> {{ total_amount|floatformat:2 }} TZS</p>
        </div>

        <button type="submit" class="btn btn-success mt-3">Save Sales Order</button>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const finalOrderCheckbox = document.getElementById("id_is_final_order");
  const closingStage = document.getElementById("closing-stage");
  const contractOutcome = document.getElementById("contract_outcome");
  const paymentSection = document.getElementById("payment-collected-section");
  const reasonLostSection = document.getElementById("reason-lost-section");
  const paymentFollowup = document.getElementById("payment-followup-section");
  const paymentCollected = document.getElementById("is_payment_collected");

  function toggleClosingStage() {
    closingStage.style.display = finalOrderCheckbox.checked ? "block" : "none";
  }

  function toggleOutcomeSections() {
    if (contractOutcome.value === "Won") {
      paymentSection.style.display = "block";
      reasonLostSection.style.display = "none";
      togglePaymentFollowup();
    } else if (contractOutcome.value === "Lost") {
      paymentSection.style.display = "none";
      reasonLostSection.style.display = "block";
      paymentFollowup.style.display = "none";
    } else {
      paymentSection.style.display = "none";
      reasonLostSection.style.display = "none";
      paymentFollowup.style.display = "none";
    }
  }

  function togglePaymentFollowup() {
    if (paymentCollected.value === "Yes-Partial") {
      paymentFollowup.style.display = "block";
    } else {
      paymentFollowup.style.display = "none";
    }
  }

  finalOrderCheckbox.addEventListener("change", toggleClosingStage);
  contractOutcome.addEventListener("change", toggleOutcomeSections);
  paymentCollected.addEventListener("change", togglePaymentFollowup);
});
</script>

{% endblock %}



<style>
/* ===== Card & Form Styling ===== */
.card {
  border-radius: 0.75rem;
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
  padding: 1rem;
}

.card-header {
  font-size: 1.25rem;
  font-weight: 600;
  display: flex;
  align-items: center;
}

.card-header i {
  margin-right: 0.5rem;
}

/* ===== Table Styling ===== */
.table-responsive {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

table {
  width: 100%;
  border-collapse: collapse;
}

table th, table td {
  padding: 0.75rem;
  text-align: left;
  vertical-align: middle;
  border: 1px solid #dee2e6;
}

table th {
  background-color: #343a40;
  color: #fff;
  font-weight: 600;
}

table tbody tr:nth-child(even) {
  background-color: #f8f9fa;
}

/* Hover effect */
table tbody tr:hover {
  background-color: #e9ecef;
}

/* ===== Form Inputs Styling ===== */
.form-control, .form-select, textarea {
  width: 100%;
  padding: 0.5rem 0.75rem;
  font-size: 0.95rem;
  line-height: 1.5;
  color: #495057;
  background-color: #fff;
  border: 1px solid #ced4da;
  border-radius: 0.375rem;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-control:focus, .form-select:focus, textarea:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
  outline: none;
}

/* Checkbox Styling */
.form-check-input {
  width: 1.25em;
  height: 1.25em;
  margin-top: 0.25rem;
}

/* Buttons */
.btn {
  border-radius: 0.375rem;
  font-size: 0.95rem;
  padding: 0.5rem 1rem;
  transition: background-color 0.2s ease;
}

.btn-success:hover {
  background-color: #198754;
}

/* Icons Spacing */
.me-1 {
  margin-right: 0.25rem !important;
}

.me-2 {
  margin-right: 0.5rem !important;
}

/* ===== Responsive Adjustments ===== */
@media (max-width: 768px) {
  table th, table td {
    font-size: 0.85rem;
    padding: 0.5rem;
  }
  
  .btn {
    width: 100%;
    margin-bottom: 0.5rem;
  }

  textarea {
    font-size: 0.9rem;
  }
}

/* Optional: Stripe alternating rows for better readability */
.table-striped tbody tr:nth-of-type(odd) {
  background-color: rgba(0,0,0,.05);
}
</style>

