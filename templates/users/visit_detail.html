{% extends "users/base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
{% include "users/sidebar.html" %}

<div class="main-panel">
  <div class="main-header">
    <div class="main-header-logo">
      <div class="logo-header" data-background-color="dark">
        <a href="index.html" class="logo">
          <img src="{% static 'assets/img/kaiadmin/logo_light.svg' %}" alt="navbar brand" class="navbar-brand" height="20" />
        </a>
        <div class="nav-toggle">
          <button class="btn btn-toggle toggle-sidebar"><i class="gg-menu-right"></i></button>
          <button class="btn btn-toggle sidenav-toggler"><i class="gg-menu-left"></i></button>
        </div>
        <button class="topbar-toggler more"><i class="gg-more-vertical-alt"></i></button>
      </div>
    </div>
    {% include "users/nav.html" %}
  </div>

  <div class="container">
    <div class="page-inner">
      <h3 class="mb-4">
        <i class="fas fa-map-marker-alt text-primary me-2"></i> Visit Details 
      </h3>

      <div class="row mb-4">
        <!-- Company & Contact Info -->
        <div class="col-md-6 col-sm-12">
          <h5><i class="fas fa-building me-1 text-secondary"></i> Company & Contact</h5>

          {% if visit.company %}
            <p><strong>Company Name:</strong> {{ visit.company.company_name }}</p>
            {% if visit.company.acquisition_stage %}
              <p>
                <strong>Acquisition Stage:</strong>
                <span class="badge 
                  {% if visit.company.acquisition_stage == 'Prospecting' %}bg-secondary
                  {% elif visit.company.acquisition_stage == 'Qualifying' %}bg-info
                  {% elif visit.company.acquisition_stage == 'Proposal or Negotiation' %}bg-warning text-dark
                  {% elif visit.company.acquisition_stage == 'Closing' %}bg-success
                  {% elif visit.company.acquisition_stage == 'Payment Followup' %}bg-primary
                  {% else %}bg-light text-dark{% endif %}">
                  {{ visit.company.acquisition_stage }}
                </span>
              </p>
            {% endif %}
          {% else %}
            <p class="text-muted">No company information available</p>
          {% endif %}

          {% if visit.contact_person %}
            <p><strong>Contact Person:</strong> {{ visit.contact_person }}</p>
          {% endif %}
          {% if visit.contact_number %}
            <p><strong>Contact Number:</strong> {{ visit.contact_number }}</p>
          {% endif %}
          {% if visit.designation %}
            <p><strong>Designation:</strong> {{ visit.designation }}</p>
          {% endif %}
          {% if visit.item_discussed %}
            <p><strong>Item Discussed:</strong> {{ visit.item_discussed }}</p>
          {% endif %}

          {% if visit.sales %}
            {% if visit.sales.status %}
              <p>
                <strong>Sale Status:</strong>
                <span class="badge 
                  {% if visit.sales.status == 'Open' %}bg-primary
                  {% elif visit.sales.status == 'Won Paid' %}bg-success
                  {% elif visit.sales.status == 'Won Pending Payment' %}bg-warning text-dark
                  {% elif visit.sales.status == 'Lost' %}bg-danger
                  {% else %}bg-light text-dark{% endif %}">
                  {{ visit.sales.status }}
                </span>
              </p>
            {% endif %}
          {% endif %}

          <p><strong>Meeting Type:</strong> {{ visit.meeting_type }}</p>
          <p><strong>Added By:</strong> 
            {% if visit.added_by %}
              {{ visit.added_by.first_name }} {{ visit.added_by.last_name }} ({{ visit.added_by.email }})
            {% else %}
              Unknown
            {% endif %}
          </p>
        </div>

        <!-- Visit Info -->
        <div class="col-md-6 col-sm-12">
          <h5><i class="fas fa-info-circle me-1 text-secondary"></i> Visit Info</h5>

          {% if visit.status %}
            <p>
              <strong>Status:</strong>
              <span class="badge 
                {% if visit.status == 'Open' %}bg-info 
                {% elif visit.status == 'Approved' %}bg-success 
                {% elif visit.status == 'Cancelled' %}bg-danger 
                {% else %}bg-light text-dark{% endif %}">
                {{ visit.status }}
              </span>
            </p>
          {% endif %}

          <p><strong>Date:</strong> {{ visit.created_at|date:"Y-m-d H:i" }}</p>

          <p><strong>Location:</strong><br>
            {% if visit.latitude and visit.longitude %}
              {{ visit.place_name }}<br>
              <small>{{ visit.region }} {{ visit.zone }} {{ visit.nation }}</small><br>
              <a href="https://www.google.com/maps/search/?api=1&query={{ visit.latitude }},{{ visit.longitude }}" target="_blank">
                <i class="fas fa-map-location-dot me-1"></i> View on Map
              </a>
            {% else %}
              <span class="text-muted">Not Available</span>
            {% endif %}
          </p>

          {% if visit.visit_image %}
            <p><strong>Visit Image:</strong></p>
            <img src="{{ visit.visit_image.url }}" alt="Visit Image" class="img-fluid rounded">
          {% endif %}
        </div>
      </div>

      <!-- Sales Details -->
      {% if visit.sales %}
      <div class="row mb-4">
        <div class="col-12">
          <h5 class="mt-4"><i class="fas fa-dollar-sign me-1 text-secondary"></i> Sales Details</h5>
          
          {% if visit.sales.client_budget %}
            <p><strong>Client Budget:</strong> {{ visit.sales.client_budget|floatformat:2|intcomma }}</p>
          {% else %}
            <p><strong>Client Budget:</strong> <span class="text-muted">Not Set</span></p>
          {% endif %}

          <h6>Products & Prices:</h6>
<div class="table-responsive">
  <table class="table table-bordered table-striped">
    <thead>
      <tr>
        <th>#</th>
        <th>Product Name</th>
        <th>Price</th>
        <th>Added At</th>
      </tr>
    </thead>
    <tbody>
      {% for item in visit.sales.items.all %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>
            {% if item.product and item.product.product %}
              {{ item.product.product.name }}
            {% else %}
              Unnamed Product
            {% endif %}
          </td>
          <td>{{ item.price|floatformat:2|intcomma }}</td>
          <td>{{ item.created_at|date:"Y-m-d H:i" }}</td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="4" class="text-center text-muted">No products added yet</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

        </div>
      </div>
      {% endif %}

      <div class="d-flex flex-wrap gap-2 mb-4">
        <a href="{% url 'user_visits' %}" class="btn btn-secondary">
          <i class="fas fa-arrow-left me-1"></i> Back to My Visits
        </a>
      </div>
    </div>
  </div>
</div>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
  .badge { font-size: 0.9rem; padding: 0.4em 0.6em; border-radius: 0.35rem; }
  table th, table td { vertical-align: middle !important; white-space: nowrap; }
  .table-responsive { overflow-x: auto; }
  .img-fluid { max-width: 100%; height: auto; display: block; margin-top: 0.5rem; }
</style>
{% endblock %}
