{% extends "users/base.html" %}
{% load static %}

{% block content %}
{% include "users/sidebar.html" %}

<div class="main-panel">
  <div class="main-header">
    {% include "users/nav.html" %}
  </div>

  <div class="container">
    <div class="page-inner">

      <!-- Messages -->
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            <i class="fa-solid fa-circle-info me-2"></i>{{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}

      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0"><i class="fa-solid fa-users me-2 text-primary"></i>Update Sale</h1>
        <a href="{% url 'sales_detail' sale.id %}" class="btn btn-outline-primary btn-sm">
          <i class="fa-solid fa-house me-1"></i>Back
        </a>
      </div>

      <!-- Stage Confirmation Modal -->
      {% if not next_stage %}
      <div class="modal" id="stageModal" tabindex="-1" style="display:block; background: rgba(0,0,0,0.5)">
        <div class="modal-dialog">
          <div class="modal-content p-4">
            <h5>Customer Stage Confirmation</h5>
            <p>This customer is currently in stage:
               <strong>{{ sale.company.acquisition_stage }}</strong>.
            </p>
            <p>Do you want to proceed to the next stage?</p>
            <button type="button" id="stageConfirm" class="btn btn-primary">Yes</button>
            <a href="{% url 'sales_detail' sale.id %}" class="btn btn-secondary">No</a>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- FORM -->
      <form method="post" enctype="multipart/form-data" id="updateSaleForm">
        {% csrf_token %}

        <!-- hidden input to hold next stage -->
        <input type="hidden" name="next_stage" id="nextStageInput" value="{{ next_stage|default:'' }}">

        <div id="formContent" {% if not next_stage %}style="display:none"{% endif %}>
          <!-- Client Information -->
          <div class="mb-3">
            <label for="{{ sales_form.company.id_for_label }}">{{ sales_form.company.label }}</label>
            {{ sales_form.company }}
          </div>
          <div class="mb-3">
            <label for="{{ sales_form.contact_person.id_for_label }}">{{ sales_form.contact_person.label }}</label>
            {{ sales_form.contact_person }}
          </div>
          <div class="mb-3">
            <label for="{{ sales_form.contact_number.id_for_label }}">{{ sales_form.contact_number.label }}</label>
            {{ sales_form.contact_number }}
          </div>
          <div class="mb-3">
            <label for="{{ sales_form.designation.id_for_label }}">{{ sales_form.designation.label }}</label>
            {{ sales_form.designation }}
          </div>
          <div class="mb-3">
            <label for="{{ sales_form.item_discussed.id_for_label }}">{{ sales_form.item_discussed.label }}</label>
            {{ sales_form.item_discussed }}
          </div>
          <div class="mb-3">
            <label for="{{ sales_form.product_interests.id_for_label }}">{{ sales_form.product_interests.label }}</label>
            {{ sales_form.product_interests }}
          </div>

          <!-- Stage-Specific Fields -->
          <div class="mb-3" id="clientBudgetWrapper" style="display:none">
            <label for="{{ update_form.client_budget.id_for_label }}">{{ update_form.client_budget.label }}</label>
            {{ update_form.client_budget }}
          </div>
          <div class="mb-3" id="isOrderFinalWrapper" style="display:none">
            <label for="{{ update_form.is_order_final.id_for_label }}">{{ update_form.is_order_final.label }}</label>
            {{ update_form.is_order_final }}
          </div>
          <div class="mb-3" id="reasonLostWrapper" style="display:none">
            <label for="{{ update_form.reason_lost.id_for_label }}">{{ update_form.reason_lost.label }}</label>
            {{ update_form.reason_lost }}
          </div>

          <!-- Product Pricing (for Proposal stage) -->
          {% if formset %}
            <h5 class="mt-4">Products & Pricing</h5>
            {{ formset.management_form }}
            {% for f in formset %}
              <div class="row mb-3">
                <div class="col-md-6">{{ f.product }}</div>
                <div class="col-md-6">{{ f.price }}</div>
              </div>
            {% endfor %}
          {% endif %}

          <div class="mt-4">
            <button type="submit" class="btn btn-success"><i class="fa-solid fa-check me-1"></i>Update Sale</button>
          </div>
        </div>
      </form>

    </div>
  </div>
</div>

<!-- SCRIPT -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const stageModal = document.getElementById("stageModal");
  const stageConfirm = document.getElementById("stageConfirm");
  const nextStageInput = document.getElementById("nextStageInput");
  const formContent = document.getElementById("formContent");

  // Stage order mapping
  const stageOrder = [
    "Prospecting",
    "Qualifying",
    "Proposal or Negotiation",
    "Closing",
    "Payment Followup"
  ];

  function getNextStage(current) {
    const i = stageOrder.indexOf(current);
    return i >= 0 && i < stageOrder.length - 1 ? stageOrder[i + 1] : current;
  }

  function showFields(stage) {
    const clientBudget = document.getElementById("clientBudgetWrapper");
    const isOrderFinal = document.getElementById("isOrderFinalWrapper");
    const reasonLost = document.getElementById("reasonLostWrapper");

    if(clientBudget) clientBudget.style.display = "none";
    if(isOrderFinal) isOrderFinal.style.display = "none";
    if(reasonLost) reasonLost.style.display = "none";

    if(stage === "Qualifying" && clientBudget) clientBudget.style.display = "block";
    if(stage === "Proposal or Negotiation" && isOrderFinal) isOrderFinal.style.display = "block";
    if(stage === "Closing" && reasonLost) reasonLost.style.display = "block";
  }

  // Confirm modal â†’ move to next stage
  if(stageConfirm) {
    stageConfirm.addEventListener("click", function() {
      const currentStage = "{{ sale.company.acquisition_stage }}";
      const nextStage = getNextStage(currentStage);
      nextStageInput.value = nextStage;
      if(stageModal) stageModal.style.display = "none";
      formContent.style.display = "block";
      showFields(nextStage);
    });
  }

  // If stage already provided (refresh case)
  {% if next_stage %}
    showFields("{{ next_stage }}");
  {% endif %}
});
</script>

{% endblock %}
