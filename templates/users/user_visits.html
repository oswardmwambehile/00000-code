{% extends "users/base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
{% include "users/sidebar.html" %}

<div class="main-panel">
  <div class="main-header">
    {% include "users/nav.html" %}
  </div>

  <div class="container">
    <div class="page-inner mt-4">

      <h3 class="mb-3">
        <i class="fas fa-map-marker-alt text-primary me-2"></i>My Visits List
      </h3>

      <!-- Visits Table -->
      {% if visits %}
      <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle w-100 custom-table">
          <thead>
            <tr>
              <th>SN</th>
              <th>Company Name</th>
              <th>Location</th>
              <th>Sent To</th>
              <th>Status</th>
              <th>Date</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for visit in visits %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ visit.sales.company.company_name|default:"N/A" }}</td>
              <td>
  {% if visit.latitude and visit.longitude %}
    <i class="fas fa-map-marker-alt text-danger me-1"></i>
    {{ visit.place_name }}<br>
    <small>{{ visit.region }} {{ visit.zone }} {{ visit.nation }}</small><br>
    <a href="https://www.google.com/maps/search/?api=1&query={{ visit.latitude }},{{ visit.longitude }}" 
       target="_blank" class="ms-1 text-decoration-none">
      <i class="fas fa-map-location-dot me-1"></i> View on Map
    </a>
  {% else %}
    <span class="text-muted">Not Available</span>
  {% endif %}
</td>

              <td>
                {% if visit.send_to %}
                  {{ visit.send_to.first_name }} {{ visit.send_to.last_name }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>
                <span class="badge 
                  {% if visit.status == 'Open' %}bg-info
                  {% elif visit.status == 'Approved' %}bg-success
                  {% elif visit.status == 'Cancelled' %}bg-danger
                  {% else %}bg-light text-dark{% endif %}">
                  {{ visit.status }}
                </span>
              </td>
              <td>{{ visit.created_at|date:"Y-m-d H:i" }}</td>
              <td class="text-nowrap">
                <!-- View Detail Button -->
                <a href="{%url 'visit_detail' visit.id%}" class="btn btn-sm btn-primary me-1 mb-1">
                  <i class="fas fa-eye"></i> View Detail
                </a>
                <!-- Delete Button -->
                <form action="" method="post" class="d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-danger mb-1" onclick="return confirm('Are you sure you want to delete this visit?');">
                    <i class="fas fa-trash-alt"></i> Delete
                  </button>
                </form>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted">No visits found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          {% if visits.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page=1">« First</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ visits.previous_page_number }}">‹ Prev</a>
            </li>
          {% endif %}

          <li class="page-item active">
            <span class="page-link">Page {{ visits.number }} of {{ visits.paginator.num_pages }}</span>
          </li>

          {% if visits.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ visits.next_page_number }}">Next ›</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ visits.paginator.num_pages }}">Last »</a>
            </li>
          {% endif %}
        </ul>
      </nav>
      {% else %}
        <p class="text-muted">No visits found.</p>
      {% endif %}

    </div>
  </div>
</div>

<!-- Styling -->
<style>
  .custom-table td, .custom-table th { white-space: nowrap; vertical-align: middle; padding: 8px 12px; }
  .custom-table thead th { background: none !important; font-weight: 600; border-bottom: 2px solid #ccc; }
  .badge { font-size: 0.85rem; }
  .btn { font-size: 0.8rem; }
  @media (max-width: 768px){
    .table-responsive { overflow-x: auto; }
    .custom-table td, .custom-table th { font-size: 0.875rem; }
  }
</style>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

{% endblock %}
