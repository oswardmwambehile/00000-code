{% extends "users/base.html" %}
{% load humanize %}

{% block content %}
  {% include "users/sidebar.html" %}
  <div class="main-panel">
    <div class="main-header">
      <div class="main-header-logo">
        <div class="logo-header" data-background-color="dark">
         
          <div class="nav-toggle">
            <button class="btn btn-toggle toggle-sidebar"><i class="gg-menu-right"></i></button>
            <button class="btn btn-toggle sidenav-toggler"><i class="gg-menu-left"></i></button>
          </div>
          <button class="topbar-toggler more"><i class="gg-more-vertical-alt"></i></button>
        </div>
      </div>
      {% include "users/nav.html" %}
    </div>

    
        

        <!-- Stats -->
        <div class="container">
      <div class="page-inner ">

        <!-- Page Header -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2 mb-4 mt-5">
          <h3 class="mb-0"><i class="fas fa-user"></i> Customer Detail – {{ customer.company_name }}</h3>
          <div class="d-flex gap-2 flex-wrap mt-2 mt-md-0">
            <a href="{% url 'customer_list' %}" class="btn btn-sm btn-outline-secondary">
              <i class="fas fa-arrow-left"></i> Back to List
            </a>
          </div>
        </div>

        <hr>

        <!-- Customer Info -->
        <div class="mb-4">
          <h5 class="mb-3"><i class="fas fa-info-circle"></i> Customer Info</h5>
          <div class="row">
            <div class="col-md-6 mb-2">
              <p><strong><i class="fas fa-building"></i> Company Name:</strong> {{ customer.company_name }}</p>
              <p><strong><i class="fas fa-id-badge"></i> Designation:</strong> {{ customer.designation }}</p>
            </div>
            <div class="col-md-6 mb-2">
              <p><strong><i class="fas fa-envelope"></i> Email:</strong> {{ customer.email }}</p>
              <p><strong><i class="fas fa-map-marker-alt"></i> Location:</strong> {{ customer.location }}</p>

              <!-- Latest Visit Tag -->
              {% with latest_visit=visits.0 %}
                <p><strong><i class="fas fa-tags"></i> Latest Tag:</strong>
                  {% if latest_visit and latest_visit.tag %}
                    <span class="badge 
                      {% if latest_visit.tag == 'Prospect' %}bg-warning text-dark
                      {% elif latest_visit.tag == 'Lead' %}bg-primary
                      {% elif latest_visit.tag == 'Customer' %}bg-success
                      {% else %}bg-light text-dark{% endif %}">
                      {{ latest_visit.tag }}
                    </span>
                  {% else %}
                    <span class="text-muted">N/A</span>
                  {% endif %}
                </p>
              {% endwith %}

            </div>
          </div>
        </div>

        <hr>

        <!-- Contacts -->
        <div class="mb-4">
          <h5 class="mb-2"><i class="fas fa-address-book"></i> Contact People</h5>
          {% if contacts %}
            <ul class="mb-0 ps-3">
              {% for contact in contacts %}
                <li><i class="fas fa-user-circle"></i> {{ contact.contact_name }} – {{ contact.contact_detail }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted"><i class="fas fa-exclamation-circle"></i> No contacts found.</p>
          {% endif %}
        </div>

        <hr>

        <!-- Visits Table -->
        <div class="mb-4">
          <h5 class="mb-3"><i class="fas fa-clipboard-list"></i> Visits / Orders</h5>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th><i class="fas fa-calendar-alt"></i> Visit Date</th>
                  <th><i class="fas fa-user-edit"></i> Ordered By</th>
                  <th><i class="fas fa-user"></i> Contact Person</th>
                  <th><i class="fas fa-tasks"></i> Stage</th>
                  <th><i class="fas fa-info-circle"></i> Status</th>
                  <th><i class="fas fa-tags"></i> Tag</th>
                  <th><i class="fas fa-cogs"></i> Action</th>
                </tr>
              </thead>
              <tbody>
                {% for visit in visits %}
                  <tr>
                    <td>{{ visit.created_at }}</td>
                    <td>{{ visit.added_by.get_full_name }}</td>
                    <td>{{ visit.contact_person.contact_name }}</td>

                    <!-- Meeting Stage -->
                    <td>
                      {% if visit.meeting_stage %}
                        <span class="badge bg-info text-white">{{ visit.meeting_stage }}</span>
                      {% else %}
                        <span class="text-muted">N/A</span>
                      {% endif %}
                    </td>

                    <!-- Status -->
                    <td>
                      {% if visit.status %}
                        <span class="badge 
                          {% if visit.status == 'Open' %}bg-secondary
                          {% elif visit.status == 'Won Paid' %}bg-success
                          {% elif visit.status == 'Won Pending Payment' %}bg-warning
                          {% elif visit.status == 'Lost' %}bg-danger
                          {% else %}bg-light text-dark{% endif %}">
                          {{ visit.status }}
                        </span>
                      {% else %}
                        <span class="text-muted">N/A</span>
                      {% endif %}
                    </td>

                    <!-- Tag -->
                    <td>
                      {% if visit.tag %}
                        <span class="badge 
                          {% if visit.tag == 'Prospect' %}bg-warning text-dark
                          {% elif visit.tag == 'Lead' %}bg-primary
                          {% elif visit.tag == 'Customer' %}bg-success
                          {% else %}bg-light text-dark{% endif %}">
                          {{ visit.tag }}
                        </span>
                      {% else %}
                        <span class="text-muted">N/A</span>
                      {% endif %}
                    </td>

                    <!-- Action -->
                    <td>
                      {% if visit.products.all %}
                        <a href="{% url 'product_details' visit.id %}" class="btn btn-sm btn-info">
                          <i class="fas fa-eye"></i> View Orders
                        </a>
                      {% else %}
                        <span class="text-muted">No Products</span>
                      {% endif %}
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="7" class="text-muted text-center">
                      <i class="fas fa-info-circle"></i> No visits found.
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>

        
    
  </div>

 

  <!-- Styles -->
  <style>
    .table th, .table td {
      white-space: nowrap;
      vertical-align: middle;
    }
    .table-responsive {
      border: 1px solid #dee2e6;
      border-radius: 8px;
    }
    .fw-bold { font-weight: 600; }
    .fw-semibold { font-weight: 500; }
    @media (max-width: 768px) {
      .d-flex.justify-content-between {
        flex-direction: column !important;
        align-items: flex-start !important;
      }
      .d-flex.justify-content-between a {
        margin-top: 10px;
      }
      .container-fluid {
        padding: 0 1rem;
      }
    }
  </style>

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

{% endblock %}
