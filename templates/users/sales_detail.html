{% extends "users/base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
{% include "users/sidebar.html" %}

<div class="main-panel">
  <div class="main-header">
    {% include "users/nav.html" %}
  </div>

  <div class="container">
    <div class="page-inner">
      <h3 class="mb-4">
        <i class="fas fa-info-circle text-primary me-2"></i> Sales Details
      </h3>

      <!-- Company & Contact Info -->
      <div class="row mb-4">
        <div class="col-md-6 col-sm-12">
          <h5><i class="fas fa-building me-1 text-secondary"></i> Company & Contact</h5>
          <p><strong>Company Name:</strong> {{ sale.company.company_name }}</p>
          <p><strong>Contact Person:</strong> 
            {% if sale.contact_person %}
              {{ sale.contact_person.contact_name }}
            {% else %}
              N/A
            {% endif %}
          </p>
          <p><strong>Contact Number:</strong> {{ sale.contact_number }}</p>
          <p><strong>Designation:</strong> {{ sale.designation }}</p>
        </div>

        <div class="col-md-6 col-sm-12">
          <h5><i class="fas fa-briefcase me-1 text-secondary"></i> Sale Info</h5>
          <p>
            <strong>Status:</strong> 
            <span class="badge 
              {% if sale.status == 'Open' %}bg-primary
              {% elif sale.status == 'Won Paid' %}bg-success
              {% elif sale.status == 'Lost' %}bg-danger
              {% else %}bg-light text-dark{% endif %}">
              <i class="fas fa-circle me-1"></i> {{ sale.status }}
            </span>
          </p>
          <p><strong>Acquisition Stage:</strong> <span class="badge 
                  {% if sale.company.acquisition_stage == 'Prospecting' %}bg-warning text-dark
                  {% elif sale.company.acquisition_stage == 'Qualifying' %}bg-primary
                  {% elif sale.company.acquisition_stage == 'Proposal or Negotiation' %}bg-info text-dark
                  {% elif sale.company.acquisition_stage == 'Closing' %}bg-success
                  {% elif sale.company.acquisition_stage == 'Payment Followup' %}bg-secondary text-white
                  {% else %}bg-light text-dark{% endif %}">
                  {{ sale.company.acquisition_stage }}
                </span></p>
                {% if sale.company.client_budget %}
  <p>
    <strong>Client Budget:</strong> ${{ sale.company.client_budget|floatformat:2 }}
  </p>
  {% endif %}
          <p><strong>Created At:</strong> {{ sale.created_at|date:"Y-m-d H:i" }}</p>
          <p><strong>Updated At:</strong> {{ sale.updated_at|date:"Y-m-d H:i" }}</p>
        </div>
      </div>

     <!-- Products Interested -->
<div class="mb-4">
  <h5><i class="fas fa-industry me-1 text-info"></i> Products Interested</h5>
  {% if sale.product_interests.exists %}
  <div class="table-responsive">
    <table class="table table-bordered table-striped align-middle w-100">
      <thead class="table-light">
        <tr>
          <th>Created At</th>
          <th>Product</th>
          <th>Price</th>
        </tr>
      </thead>
      <tbody>
        {% for product, item in product_items %}
        <tr>
          <td>{{ item.created_at|date:"Y-m-d" }}</td>
          <td>{{ product.product }}</td> {# Product name from ProductInterest #}
          <td>${{ item.price|floatformat:2 }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="text-muted">No products linked to this sale.</p>
  {% endif %}
</div>

      <!-- Item Discussed -->
      {% if sale.item_discussed %}
      <div class="mb-3">
        <h5><i class="fas fa-comments me-1 text-success"></i> Item Discussed</h5>
        <p>{{ sale.item_discussed }}</p>
      </div>
      {% endif %}

      <!-- Reason Lost -->
      {% if sale.reason_lost %}
      <div class="mb-3">
        <h5><i class="fas fa-times-circle me-1 text-danger"></i> Reason Lost</h5>
        <p>{{ sale.reason_lost }}</p>
      </div>
      {% endif %}

      <!-- Action Buttons -->
      <div class="d-flex flex-wrap gap-2 mb-4">
        <a href="{% url 'sales_list' %}" class="btn btn-secondary">
          <i class="fas fa-arrow-left me-1"></i> Back to Sales
        </a>
        <a href="#" class="btn btn-info">
          <i class="fas fa-history me-1"></i> View Sales History
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
.badge { font-size: 0.9rem; padding: 0.4em 0.6em; border-radius: 0.35rem; }
table th, table td { vertical-align: middle !important; white-space: nowrap; }
.table-responsive { overflow-x: auto; }
</style>
{% endblock %}
