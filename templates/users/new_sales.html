{% extends "users/base.html" %}
{% load static %}

{% block content %}
{% include "users/sidebar.html" %}

<!-- URL templates for AJAX -->
<div id="url-templates" 
     data-get-contacts-url="{% url 'get_contacts' 0 %}" 
     data-get-contact-details-url="{% url 'get_contact_details' 0 %}">
</div>

<div class="main-panel">
  <div class="main-header">
    {% include "users/nav.html" %}
  </div>

  <div class="container">
    <div class="page-inner">

      <!-- Messages -->
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            <i class="fa-solid fa-circle-info me-2"></i>{{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}

      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0"><i class="fa-solid fa-users me-2 text-primary"></i>New Client Visit</h1>
        <a href="{% url 'add_visit' %}" class="btn btn-outline-primary btn-sm">
          <i class="fa-solid fa-house me-1"></i>Home
        </a>
      </div>

      <!-- FORM -->
      <form method="post" enctype="multipart/form-data" id="multiStepForm">
        {% csrf_token %}

        <!-- STEP 1 -->
        <div class="step" id="step-1">
          <h5 class="mb-3"><i class="fa-solid fa-user-tie me-2 text-secondary"></i>Step 1: Client Information</h5>

          <div class="mb-3">
            <label for="{{ form.company.id_for_label }}">{{ form.company.label }} <span class="text-danger">*</span></label>
            {{ form.company }}
          </div>

          <div class="mb-3">
            <label for="{{ form.contact_person.id_for_label }}">{{ form.contact_person.label }} <span class="text-danger">*</span></label>
            {{ form.contact_person }}
          </div>

          <div class="mb-3">
            <label for="{{ form.contact_number.id_for_label }}">{{ form.contact_number.label }}</label>
            {{ form.contact_number }}
          </div>

          <div class="mb-3">
            <label for="{{ form.designation.id_for_label }}">{{ form.designation.label }}</label>
            {{ form.designation }}
          </div>

          <button type="button" class="btn btn-primary next-step mt-3">
            <i class="fa-solid fa-arrow-right me-1"></i>Next
          </button>
        </div>

        <!-- STEP 2 -->
        <div class="step d-none" id="step-2">
          <h5 class="mb-3"><i class="fa-solid fa-comments me-2 text-info"></i>Step 2: Discussion & Interests</h5>

          <div class="mb-3">
            <label for="{{ form.item_discussed.id_for_label }}">{{ form.item_discussed.label }} <span class="text-danger">*</span></label>
            {{ form.item_discussed }}
          </div>

          <div class="mb-3">
            <label for="{{ form.product_interests.id_for_label }}">{{ form.product_interests.label }} <span class="text-danger">*</span></label>
            {{ form.product_interests }}
          </div>

          <div class="mt-4 d-flex gap-2">
            <button type="button" class="btn btn-danger prev-step"><i class="fa-solid fa-arrow-left me-1"></i>Back</button>
            <button type="submit" class="btn btn-success"><i class="fa-solid fa-check me-1"></i>Submit Visit</button>
          </div>
        </div>
      </form>

    </div>
  </div>
</div>

<!-- SCRIPT -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  let currentStep = 1;
  const steps = document.querySelectorAll(".step");

  function showStep(step) {
    steps.forEach((s, i) => s.classList.toggle("d-none", i !== step - 1));
  }
  showStep(currentStep);

  // Utility: show error below input
  function showError(input, message) {
    let error = input.nextElementSibling;
    if (!error || !error.classList.contains("text-danger")) {
      error = document.createElement("div");
      error.className = "text-danger small mt-1";
      input.parentNode.appendChild(error);
    }
    error.textContent = message;
    input.classList.add("is-invalid");
  }

  function clearError(input) {
    let error = input.nextElementSibling;
    if (error && error.classList.contains("text-danger")) {
      error.remove();
    }
    input.classList.remove("is-invalid");
  }

  // Validate Step 1 fields
  function validateStep1() {
    const fields = [
      document.getElementById("id_company"),
      document.getElementById("id_contact_person")
    ];
    let valid = true;
    fields.forEach(f => {
      clearError(f);
      if (!f.value || f.value.trim() === "") {
        showError(f, "This field is required");
        valid = false;
      }
    });
    return valid;
  }

  // Validate Step 2 fields
  function validateStep2() {
    const fields = [
      document.getElementById("id_item_discussed"),
      document.getElementById("id_product_interests")
    ];
    let valid = true;
    fields.forEach(f => {
      clearError(f);
      if (!f.value || f.value.trim() === "") {
        showError(f, "This field is required");
        valid = false;
      }
    });
    return valid;
  }

  // NEXT button
  document.querySelectorAll(".next-step").forEach(btn => {
    btn.addEventListener("click", () => {
      if (currentStep === 1 && !validateStep1()) return;
      if (currentStep < steps.length) { 
        currentStep++; 
        showStep(currentStep); 
      }
    });
  });

  // PREV button
  document.querySelectorAll(".prev-step").forEach(btn => {
    btn.addEventListener("click", () => {
      if (currentStep > 1) { 
        currentStep--; 
        showStep(currentStep); 
      }
    });
  });

  // FORM submit validation
  const form = document.getElementById("multiStepForm");
  form.addEventListener("submit", function (e) {
    let valid = true;
    if (!validateStep1()) {
      currentStep = 1;
      showStep(currentStep);
      valid = false;
    } else if (!validateStep2()) {
      currentStep = 2;
      showStep(currentStep);
      valid = false;
    }

    if (!valid) e.preventDefault();
  });

  // COMPANY â†’ CONTACT AJAX
  const urlTemplatesDiv = document.getElementById("url-templates");
  const getContactsUrlTemplate = urlTemplatesDiv.dataset.getContactsUrl;
  const getContactDetailsUrlTemplate = urlTemplatesDiv.dataset.getContactDetailsUrl;

  function buildUrl(template, id) {
    return template.replace(/0\/$/, id + '/');
  }

  const companySelect = document.getElementById("id_company");
  const contactSelect = document.getElementById("id_contact_person");
  const contactNumber = document.getElementById("id_contact_number");
  const designation = document.getElementById("id_designation");

  if (contactNumber) contactNumber.readOnly = true;
  if (designation) designation.readOnly = true;

  companySelect.addEventListener("change", () => {
    const companyId = companySelect.value;
    if (!companyId) {
      contactSelect.innerHTML = `<option value="">Select contact</option>`;
      contactNumber.value = ""; designation.value = "";
      return;
    }
    contactSelect.innerHTML = `<option>Loading...</option>`;
    fetch(buildUrl(getContactsUrlTemplate, companyId))
      .then(res => res.json())
      .then(data => {
        contactSelect.innerHTML = `<option value="">Select contact</option>`;
        data.contacts.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = c.contact_name;
          contactSelect.appendChild(opt);
        });
      });
  });

  contactSelect.addEventListener("change", () => {
    const contactId = contactSelect.value;
    if (!contactId) {
      contactNumber.value = "";
      designation.value = "";
      return;
    }
    fetch(buildUrl(getContactDetailsUrlTemplate, contactId))
      .then(res => res.json())
      .then(data => {
        contactNumber.value = data.contact_number || "";
        designation.value = data.designation || "";
      });
  });
});
</script>


<!-- STYLES -->
<style>
  /* Headers */
  h1, h5 { font-weight: 600; }

  /* Labels */
  label { font-weight: 500; margin-bottom: 0.5rem; display: block; }

  /* Buttons */
  .btn { 
    border-radius: 8px; 
    padding: 0.6rem 1.2rem; 
    font-size: 0.95rem; 
    transition: all 0.2s ease; 
  }

  .btn:hover { transform: scale(1.03); }

  /* Inputs, selects, textareas */
  input, select, textarea {
    width: 100% !important;
    min-height: 50px;             /* Increased height */
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 0.8rem 1rem;
    font-size: 1rem;
    background: transparent !important;  /* Fully transparent background */
    color: #000;
    box-shadow: none !important;
    transition: all 0.2s ease;
  }

  input:focus, select:focus, textarea:focus {
    border-color: #007bff !important;
    outline: none !important;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
    background: transparent !important;
  }

  /* Multi-step form */
  .step { transition: all 0.3s ease; }

  /* Row and column adjustments for responsiveness */
  @media (max-width: 992px) {
    .row { flex-direction: column; }
    .col-md-6 { width: 100%; padding: 0; }
  }

  @media (max-width: 576px) {
    .btn { width: 100%; margin-bottom: 0.5rem; }
  }

  /* Step spacing */
  .mb-3 { margin-bottom: 1.5rem; }

  /* Optional: subtle hover effect on selects */
  select:hover { border-color: #007bff; }
</style>



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

{% endblock %}
