{% extends "users/base.html" %}
{% load static %}

{% block content %}
{% include "users/sidebar.html" %}

<div class="main-panel">
  <div class="main-header">
    {% include "users/nav.html" %}
  </div>

  <div class="container">
    <div class="page-inner">

      <!-- Messages -->
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            <i class="fa-solid fa-circle-info me-2"></i>{{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}

      <h1 class="mb-4"><i class="fa-solid fa-plus-circle me-2 text-primary"></i>Add New Visit</h1>

      <form method="post" enctype="multipart/form-data" id="visitForm">
        {% csrf_token %}

        <!-- Recipient -->
        <div class="mb-3">
          <label for="{{ form.send_to.id_for_label }}">{{ form.send_to.label }}</label>
          {{ form.send_to }}
        </div>

        <!-- Meeting Type -->
        <div class="mb-3">
          <label for="{{ form.meeting_type.id_for_label }}">{{ form.meeting_type.label }}</label>
          {{ form.meeting_type }}
        </div>

        <!-- Latitude & Longitude -->
        {{ form.latitude }} {{ form.longitude }}

        <!-- Map -->
        <label class="form-label"><i class="fa-solid fa-map-pin me-1 text-danger"></i>Pin Location</label>
        <div id="map" class="mb-2 border rounded" style="height: 300px;"></div>
        <div id="location-details" class="p-2 border rounded small text-muted">Please allow location access‚Ä¶</div>

        <!-- Comment -->
        <div class="mb-3">
          <label for="{{ form.comment.id_for_label }}">{{ form.comment.label }}</label>
          {{ form.comment }}
        </div>

        <!-- Visit Image -->
        <div class="mb-3">
          <label for="{{ form.visit_image.id_for_label }}">{{ form.visit_image.label }}</label>
          {{ form.visit_image }}
        </div>

        <button type="submit" class="btn btn-success">
          <i class="fa-solid fa-check me-1"></i>Submit Visit
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const latInput = document.getElementById("id_latitude");
  const lonInput = document.getElementById("id_longitude");
  const locationDetails = document.getElementById("location-details");
  const submitBtn = document.querySelector('button[type="submit"]');
  submitBtn.disabled = true;

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(position => {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      latInput.value = lat.toFixed(6);
      lonInput.value = lon.toFixed(6);
      submitBtn.disabled = false;

      const map = L.map('map').setView([lat, lon], 15);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
      L.marker([lat, lon]).addTo(map);
      locationDetails.textContent = `üìç Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}`;
    }, () => { locationDetails.textContent = "‚ùå Unable to retrieve location. Please allow location access."; });
  } else {
    locationDetails.textContent = "‚ö†Ô∏è Geolocation not supported by your browser.";
  }
});
</script>

<style>
#map { height: 220px; width: 100%; border: 2px solid #aaa; border-radius: 6px; margin-bottom: 10px; }
label { font-weight: 500; margin-bottom: 4px; display: block; }
input, select, textarea { width: 100%; padding: 10px; border: 2px solid #ccc; border-radius: 6px; }
input:focus, select:focus, textarea:focus { border-color: #007bff; outline: none; }

/* Headers */
  h1, h5 { font-weight: 600; }

  /* Labels */
  label { font-weight: 500; margin-bottom: 0.5rem; display: block; }

  /* Buttons */
  .btn { 
    border-radius: 8px; 
    padding: 0.6rem 1.2rem; 
    font-size: 0.95rem; 
    transition: all 0.2s ease; 
  }

  .btn:hover { transform: scale(1.03); }

  /* Inputs, selects, textareas */
  input, select, textarea {
    width: 100% !important;
    min-height: 50px;             /* Increased height */
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 0.8rem 1rem;
    font-size: 1rem;
    background: transparent !important;  /* Fully transparent background */
    color: #000;
    box-shadow: none !important;
    transition: all 0.2s ease;
  }

  input:focus, select:focus, textarea:focus {
    border-color: #007bff !important;
    outline: none !important;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
    background: transparent !important;
  }

  /* Multi-step form */
  .step { transition: all 0.3s ease; }

  /* Row and column adjustments for responsiveness */
  @media (max-width: 992px) {
    .row { flex-direction: column; }
    .col-md-6 { width: 100%; padding: 0; }
  }

  @media (max-width: 576px) {
    .btn { width: 100%; margin-bottom: 0.5rem; }
  }

  /* Step spacing */
  .mb-3 { margin-bottom: 1.5rem; }

  /* Optional: subtle hover effect on selects */
  select:hover { border-color: #007bff; }
</style>

{% endblock %}
