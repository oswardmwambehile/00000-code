{% extends "users/base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
{% include "users/sidebar.html" %}

<div id="url-templates" 
     data-get-contacts-url="{% url 'get_contacts' 0 %}" 
     data-get-contact-details-url="{% url 'get_contact_details' 0 %}">
</div>

<div class="main-panel">
  <div class="main-header">
    {% include "users/nav.html" %}
  </div>

  <div class="container">
    <div class="page-inner">

      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          <i class="fa-solid fa-circle-info me-2"></i>{{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}

      <h1 class="mb-4"><i class="fa-solid fa-plus-circle me-2 text-primary"></i>Add New Visit</h1>

      <form method="post" enctype="multipart/form-data" id="visitForm">
        {% csrf_token %}

        <!-- Company -->
        <div class="mb-3">
          <label for="id_company" class="form-label">{{ form.company.label }}</label>
          {% render_field form.company class="form-select" id="id_company" placeholder="Select a company" %}
          <div class="invalid-feedback"></div>
        </div>

        <!-- Contact Person -->
        <div class="mb-3">
          <label for="id_contact_person" class="form-label">{{ form.contact_person.label }}</label>
          {% render_field form.contact_person class="form-select" id="id_contact_person" placeholder="Select contact person" %}
          <div class="invalid-feedback"></div>
        </div>

        <!-- Contact Number -->
        <div class="mb-3">
          <label for="id_contact_number" class="form-label">{{ form.contact_number.label }}</label>
          {% render_field form.contact_number class="form-control" readonly="readonly" id="id_contact_number" placeholder="Contact number will auto-fill" %}
        </div>

        <!-- Designation -->
        <div class="mb-3">
          <label for="id_designation" class="form-label">{{ form.designation.label }}</label>
          {% render_field form.designation class="form-control" readonly="readonly" id="id_designation" placeholder="Designation will auto-fill" %}
        </div>

        <!-- Item Discussed -->
        <div class="mb-3">
          <label>{{ form.item_discussed.label }}</label>
          {% render_field form.item_discussed class="form-control" placeholder="Enter items discussed" id="id_item_discussed" %}
          <div class="invalid-feedback"></div>
        </div>

        <!-- Meeting Type -->
        <div class="mb-3">
          <label>{{ form.meeting_type.label }}</label>
          {% render_field form.meeting_type class="form-select" placeholder="Select meeting type" id="id_meeting_type" %}
          <div class="invalid-feedback"></div>
        </div>

        <!-- Visit Image -->
        <div class="mb-3">
          <label>{{ form.visit_image.label }}</label>
          {% render_field form.visit_image class="form-control" placeholder="Upload visit image" id="id_visit_image" %}
          <div class="invalid-feedback"></div>
        </div>

        {{ form.latitude }}
        {{ form.longitude }}

        <!-- Map -->
        <label class="form-label"><i class="fa-solid fa-map-pin me-1 text-danger"></i>Pin Location</label>
        <div id="map" style="height: 300px;" class="mb-2 border rounded"></div>
        <div id="location-details" class="p-2 border rounded small text-muted">Please allow location access…</div>

        <button type="submit" class="btn btn-success"><i class="fa-solid fa-check me-1"></i>Submit Visit</button>
      </form>

    </div>
  </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/circles/0.0.6/circles.min.js"></script>
<script src="{% static 'js/demo.js' %}"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const latInput = document.getElementById("id_latitude");
    const lonInput = document.getElementById("id_longitude");
    const locationDetails = document.getElementById("location-details");
    const submitBtn = document.querySelector('button[type="submit"]');

    // Disable submit until location is ready
    submitBtn.disabled = true;

    function initMap(lat, lon) {
        // Create Leaflet map
        const map = L.map('map').setView([lat, lon], 15);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Add draggable marker
        const marker = L.marker([lat, lon], { draggable: true }).addTo(map);

        // Update hidden inputs when marker is dragged
        marker.on('dragend', function(e) {
            const pos = marker.getLatLng();
            latInput.value = pos.lat.toFixed(6);
            lonInput.value = pos.lng.toFixed(6);
            locationDetails.textContent = `📍 Lat: ${pos.lat.toFixed(5)}, Lon: ${pos.lng.toFixed(5)}`;
        });

        // Update location details immediately
        locationDetails.textContent = `📍 Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}`;
    }

    // Get geolocation
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                latInput.value = lat.toFixed(6);
                lonInput.value = lon.toFixed(6);
                submitBtn.disabled = false;

                initMap(lat, lon);
            },
            function(error) {
                let msg = "❌ Unable to retrieve location.";
                if (error.code === 1) msg = "❌ Permission denied. Please allow location access.";
                if (error.code === 2) msg = "❌ Position unavailable.";
                if (error.code === 3) msg = "❌ Location request timed out.";
                locationDetails.textContent = msg;
                console.error("Geolocation error:", error);

                // Fallback: center map on a default location (optional)
                const defaultLat = 0;
                const defaultLon = 0;
                latInput.value = defaultLat;
                lonInput.value = defaultLon;
                initMap(defaultLat, defaultLon);
                submitBtn.disabled = false;
            }
        );
    } else {
        locationDetails.textContent = "⚠️ Geolocation not supported by your browser.";
        // Fallback: default location
        const defaultLat = 0;
        const defaultLon = 0;
        latInput.value = defaultLat;
        lonInput.value = defaultLon;
        initMap(defaultLat, defaultLon);
        submitBtn.disabled = false;
    }

    // COMPANY → CONTACT auto-fill logic (kept as is)
    const urlTemplatesDiv = document.getElementById("url-templates");
    const getContactsUrlTemplate = urlTemplatesDiv.dataset.getContactsUrl;
    const getContactDetailsUrlTemplate = urlTemplatesDiv.dataset.getContactDetailsUrl;

    function buildUrl(template, id) { return template.replace(/0\/$/, id + '/'); }

    const companySelect = document.getElementById("id_company");
    const contactSelect = document.getElementById("id_contact_person");
    const contactNumber = document.getElementById("id_contact_number");
    const designation = document.getElementById("id_designation");

    companySelect.addEventListener("change", () => {
        const companyId = companySelect.value;
        if (!companyId) {
            contactSelect.innerHTML = `<option value="">Select contact</option>`;
            contactNumber.value = "";
            designation.value = "";
            return;
        }
        contactSelect.innerHTML = `<option value="">Loading...</option>`;
        fetch(buildUrl(getContactsUrlTemplate, companyId))
            .then(res => res.json())
            .then(data => {
                contactSelect.innerHTML = `<option value="">Select contact</option>`;
                data.contacts.forEach(c => {
                    const opt = document.createElement("option");
                    opt.value = c.id; opt.textContent = c.contact_name;
                    contactSelect.appendChild(opt);
                });
                contactNumber.value = "";
                designation.value = "";
            });
    });

    contactSelect.addEventListener("change", () => {
        const contactId = contactSelect.value;
        if (!contactId) { contactNumber.value = ""; designation.value = ""; return; }
        fetch(buildUrl(getContactDetailsUrlTemplate, contactId))
            .then(res => res.json())
            .then(data => {
                contactNumber.value = data.contact_number || "";
                designation.value = data.designation || "";
            });
    });

    // FORM validation (kept as is)
    const visitForm = document.getElementById("visitForm");
    visitForm.addEventListener("submit", function(e) {
        let valid = true;
        const requiredFields = [
            "id_company",
            "id_contact_person",
            "id_item_discussed",
            "id_meeting_type",
            "id_visit_image"
        ];
        requiredFields.forEach(id => {
            const el = document.getElementById(id);
            const feedback = el.nextElementSibling;
            if (el.type === "file") {
                if (!el.files || el.files.length === 0) { el.classList.add("is-invalid"); feedback.textContent = "This field is required"; valid=false; } 
                else { el.classList.remove("is-invalid"); feedback.textContent = ""; }
            } else {
                if (!el.value.trim()) { el.classList.add("is-invalid"); feedback.textContent = "This field is required"; valid=false; } 
                else { el.classList.remove("is-invalid"); feedback.textContent = ""; }
            }
        });
        if (!valid) e.preventDefault();
    });
});
</script>






<style>
#map { height: 220px; width: 100%; border: 2px solid #aaa; border-radius: 6px; margin-bottom: 10px; }
label { font-weight: 500; margin-bottom: 4px; display: block; }
input, select, textarea { width: 100%; padding: 10px; border: 2px solid #ccc; border-radius: 6px; }
input:focus, select:focus, textarea:focus { border-color: #007bff; outline: none; }

/* Headers */
  h1, h5 { font-weight: 600; }

  /* Labels */
  label { font-weight: 500; margin-bottom: 0.5rem; display: block; }

  /* Buttons */
  .btn { 
    border-radius: 8px; 
    padding: 0.6rem 1.2rem; 
    font-size: 0.95rem; 
    transition: all 0.2s ease; 
  }

  .btn:hover { transform: scale(1.03); }

  /* Inputs, selects, textareas */
  input, select, textarea {
    width: 100% !important;
    min-height: 50px;             /* Increased height */
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 0.8rem 1rem;
    font-size: 1rem;
    background: transparent !important;  /* Fully transparent background */
    color: #000;
    box-shadow: none !important;
    transition: all 0.2s ease;
  }

  input:focus, select:focus, textarea:focus {
    border-color: #007bff !important;
    outline: none !important;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
    background: transparent !important;
  }

  /* Multi-step form */
  .step { transition: all 0.3s ease; }

  /* Row and column adjustments for responsiveness */
  @media (max-width: 992px) {
    .row { flex-direction: column; }
    .col-md-6 { width: 100%; padding: 0; }
  }

  @media (max-width: 576px) {
    .btn { width: 100%; margin-bottom: 0.5rem; }
  }

  /* Step spacing */
  .mb-3 { margin-bottom: 1.5rem; }

  /* Optional: subtle hover effect on selects */
  select:hover { border-color: #007bff; }
</style>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

{% endblock %}
